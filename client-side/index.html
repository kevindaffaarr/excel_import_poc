<!DOCTYPE html>
<html>
<head>
    <title>Excel to JSON</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,height=device-height,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
    <script type="text/javascript" src="https://cdn.sheetjs.com/xlsx-0.19.2/package/dist/xlsx.full.min.js"></script>
</head>
<body>
    <style>
        div {
            width: "device-width"
        }
    </style>
    
    <!-- Header Excel 2 JSON -->
    <h1>Excel 2 JSON</h1>
    <!-- Create File Form -->
    <div>
        <input type="file" name="file" id="fileInput">
    </div>

    <!-- pre result -->
    <div id="result"></div>
</body>
<script>
/**
 * Merge Object with same keys to array
 * @param json - json from excel
 * @returns
 * Example:
 * [{"id":1, "name":"Josh"},{"id":1,"hobby":"swimming"},{"id":1,"hobby":"soccer"},{"id":1,"name":"john"}]
 * [{"id":1, "name":["Josh","john"],"hobby":["swimming","soccer"]}]
 */
const mergeObjects = (json) => {
    let result = {};
    json.forEach(item => {
        Object.keys(item).forEach(key => {
            if (!result[key]) {
                result[key] = [];
            }
            result[key].push(item[key]);
        });
    });
    Object.keys(result).forEach(key => {
        if (Array.isArray(result[key]) && result[key].length === 1) {
            result[key] = result[key][0];
        }
    });
    return result;
};

/**
 * Unflatten Dot Notation JSON
 * @param data - json with dot notation key
 * @returns 
 */
const unflattenDotJson = (data) => {
    const result = {};
    for (const i in data) {
        const keys = i.split('.');
        keys.reduce((r, e, j) => {
            return r[e] || (r[e] = isNaN(Number(keys[j + 1])) ? (keys.length - 1 === j ? data[i] : {}) : []);
        }, result);
    }
    return result;
};

/**
 * Reformat JSON from like
 * {"legalitas":{"jenis":[1,2,3,4],"nomor":[1,2,3,4],"tanggal":[1,2,3,4]}},
 * {"risiko": {"banjir":1, "kebakaran":2, "gempa":3, "tsunami":4}},
 * {"dp":{"discount":[1,2,3],"jenisdata":["penawaran","transaksi","penawaran"],"spesifikasi":{jenis:["panjang","lebar"],"satuan":["m","m"],"value":[1,2,3]}}}
 * to:
 * {"legalitas":[{"jenis":1,"nomor":1,"tanggal":1},{"jenis":2,"nomor":2,"tanggal":2},{"jenis":3,"nomor":3,"tanggal":3},{"jenis":4,"nomor":4,"tanggal":4}]}
 * {"risiko":{"banjir":1},{"kebakaran":2},{"gempa":3},{"tsunami":4}}
 * {"dp":[{"discount":1,"jenisdata":"penawaran","spesifikasi":[{"jenis":"panjang","satuan":"m","value":1},{"jenis":"lebar","satuan":"m","value":2}]},{"discount":2,"jenisdata":"transaksi","spesifikasi":[{"jenis":"panjang","satuan":"m","value":1},{"jenis":"lebar","satuan":"m","value":2}]},{"discount":3,"jenisdata":"penawaran","spesifikasi":[{"jenis":"panjang","satuan":"m","value":1},{"jenis":"lebar","satuan":"m","value":2}]}]}
 */
const reformatChildObject = (obj) => {
    const result = {};

    Object.keys(obj).forEach(key => {
        if (typeof obj[key] === 'object' && !Array.isArray(obj[key])) {
            const childObj = obj[key];
            Object.keys(childObj).forEach(childKey => {
                if (Array.isArray(childObj[childKey])) {
                    const childArr = childObj[childKey];
                    childArr.forEach((item, index) => {
                        if (!result[key]) {
                            result[key] = [];
                        }
                        if (!result[key][index]) {
                            result[key][index] = {};
                        }
                        if (!result[key][index][childKey]) {
                            result[key][index][childKey] = [];
                        }
                        result[key][index][childKey] = item;
                    });
                } else if (typeof childObj[childKey] === 'object') {
                    const child2Obj = childObj[childKey];
                    Object.keys(child2Obj).forEach(child2Key => {
                        // asumsi: child2Obj[child2Key] selalu array karena max level 3, contoh: dp.spesifikasi.jenis
                        child2Obj[child2Key].forEach((child2KeyVal, index2KeyValObj) => {
                            const child2KeyValArrObj = convertStringArray(child2KeyVal);
                            child2KeyValArrObj.forEach((child2KeyValArrObjItem, index2KeyValObjArr) => {
                                if (!result[key]) {
                                    result[key] = [];
                                }
                                if (!result[key][index2KeyValObj]) {
                                    result[key][index2KeyValObj] = {};
                                }
                                if (!result[key][index2KeyValObj][childKey]) {
                                    result[key][index2KeyValObj][childKey] = [];
                                }
                                if (!result[key][index2KeyValObj][childKey][index2KeyValObjArr]) {
                                    result[key][index2KeyValObj][childKey][index2KeyValObjArr] = {};
                                }
                                result[key][index2KeyValObj][childKey][index2KeyValObjArr][child2Key] = child2KeyValArrObjItem;
                            });
                        });
                    });
                    
                } else {
                    if (!result[key]) {
                        result[key] = {};
                    }
                    result[key][childKey] = childObj[childKey];
                }
            });
        } else {
            result[key] = obj[key];
        }
    });

    return result;
};

/** Convert multilevel JSON array string to true array
 * Example: "array(1,2,3)" to [1,2,3]
 * Retain the variable type whether it is a number or string
 */
const convertStringArray = (str) => {
    // if value is a string, check if it is an array
    if (typeof str === 'string') {
        // if value is an array, convert it to true array
        if (str.includes('array')) {
            const arr = str.replace('array(', '').replace(')', '').split(',');
            str = arr.map(item => {
                if (isNaN(Number(item))) {
                    return item;
                } else {
                    return Number(item);
                }
            });
        }
    }
    return str;
}
</script>

<script>
    const sheetName = 'parsed';
    const fileInput = document.getElementById('fileInput');
    const resultPre = document.getElementById('result');

    fileInput.addEventListener('change', async () => {
        const file = fileInput.files[0];
        const reader = new FileReader();
        reader.readAsArrayBuffer(file);

        reader.onload = async (e) => {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const xlData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);
            const mergedData = mergeObjects(xlData);
            const unflattenData = unflattenDotJson(mergedData);
            const reformatData = reformatChildObject(unflattenData);
            const convertedString = convertStringArray(reformatData);
            resultPre.innerHTML = JSON.stringify(convertedString);
        };
    });
</script>
</html>